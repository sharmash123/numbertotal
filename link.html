<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Store Grid Table (Fixed Parser)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body{font-family:'Segoe UI',Arial,sans-serif;background:#f4f9fe;margin:0;padding:20px 8px 80px 8px;}
.header-top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;}
.header-top input[type="text"]{padding:8px 10px;border-radius:6px;border:1px solid #b5c7e6;font-size:15px;}
.header-top button{background:#3a5bea;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:15px;}
.header-top button:hover{background:#2233a2;}
h1{margin:6px 0 12px 0;color:#273356;font-size:20px;}
.controls{margin-bottom:12px;display:flex;flex-wrap:wrap;align-items:center;gap:8px 10px;}
.controls label{display:flex;gap:6px;align-items:center;font-size:14px;color:#213;}
.controls input[type='text'],.controls input[type='number']{width:170px;max-width:90vw;font-size:16px;padding:6px 10px;border:1px solid #b5c7e6;border-radius:5px;}
.controls button{font-size:15px;padding:6px 12px;background:#3a5bea;color:#fff;border:none;border-radius:5px;cursor:pointer;transition:background .18s;}
.controls button:hover{background:#2233a2;}

.table-wrap{overflow-x:auto;width:100%;margin-top:6px;}
table{border-collapse:collapse;background:#fff;border-radius:8px;margin:0 auto;box-shadow:0 2px 14px #ccc7;width:100%;table-layout:fixed;}
th,td{border:1.5px solid #333;height:57px;font-size:22px;text-align:center;vertical-align:middle;padding:0;overflow:hidden;word-break:break-word;cursor:pointer;}
td{background:#f8fafc;font-weight:bold;position:relative;user-select:none;}
.opendigit{color:#2186cc;font-weight:bold;font-size:24px;display:inline-block;margin-right:4px;}
.closedigit{color:#eb2323;font-weight:bold;font-size:24px;display:inline-block;}
.cell-index{position:absolute;left:4px;top:4px;font-size:11px;color:#6b7280;font-weight:600;opacity:.8;}
.empty-faint{color:#9aa7bf;font-weight:600;font-size:16px;}

@media(max-width:900px){td,th{font-size:17px;height:43px}.opendigit,.closedigit{font-size:19px}}
@media(max-width:600px){td,th{font-size:14px;height:40px}.opendigit,.closedigit{font-size:14px}.table-wrap{overflow-x:hidden}}
</style>
</head>
<body>

<div class="header-top">
  <label>Chart Name:
    <input id="chartNameTop" type="text" placeholder="Type chart name here" value="My Chart">
  </label>
  <label>Save filename:
    <input id="saveFilenameTop" type="text" placeholder="store.html" value="store.html">
  </label>
  <button id="topSaveBtn">Save (Top)</button>
</div>

<h1 id="pageTitle">Store Grid Table â€” <span id="chartDisplay">My Chart</span></h1>

<div class="controls">
  <label>Rows: <input id="rowsInput" type="number" value="17" min="1" max="2000"></label>
  <label>Cols: <input id="colsInput" type="number" value="7" min="1" max="50"></label>
  <button id="resizeBtn">Modify Size</button>
  <button id="showIndexBtn">Show Index: <span id="showIndexState">OFF</span></button>
</div>

<div class="controls">
  <input id="openInput" placeholder="Open: 2-digit numbers or **/xx (paste grid allowed)" style="width:360px">
  <button id="openBtn">Open</button>
  <input id="closeInput" placeholder="Close: 2-digit numbers or **/xx (paste grid allowed)">
  <button id="closeBtn">Close</button>
  <button id="clearOpenBtn">Clear Open</button>
  <button id="clearCloseBtn">Clear Close</button>
  <button id="clearAllBtn">Clear All</button>
</div>

<div class="table-wrap"><table id="gridTable" role="grid" aria-label="Store Grid"></table></div>

<script>
/* CN function (unchanged) */
function calculateCN(num) {
  if (num === '**' || num.toLowerCase() === 'xx') return '*';
  if (!num || num.length !== 2 || !/^\d{2}$/.test(num)) return '';
  let a = parseInt(num[0],10), b = parseInt(num[1],10);
  let step1 = (a + b) % 10;
  let step2 = (a + a) % 10;
  return (step1 + step2) % 10;
}

/* Improved parse: match only '**', 'xx', or two-digit groups (\d{2}).
   This ignores stray separators (tabs/newlines/spaces/commas) and weird unicode spaces. */
function parseToPairs(raw) {
  if (!raw) return [];
  // remove zero-width characters and normalize NBSP
  raw = raw.replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/\u00A0/g, ' ');
  // find tokens: '**' | 'xx' | two digits (exactly)
  const matches = raw.match(/\*\*|xx|\d{2}/gi) || [];
  return matches;
}

/* state */
let ROWS = 17, COLS = 7;
let openDigits = Array(ROWS * COLS).fill('');
let closeDigits = Array(ROWS * COLS).fill('');
const table = document.getElementById('gridTable');
let SHOW_INDEX = false;

/* render */
function renderTable() {
  table.innerHTML = '';
  for (let r = 0; r < ROWS; r++) {
    const tr = document.createElement('tr');
    for (let c = 0; c < COLS; c++) {
      const td = document.createElement('td');
      const idx = r * COLS + c;
      td.dataset.idx = idx;
      const open = openDigits[idx] || '';
      const close = closeDigits[idx] || '';
      if (open || close) td.innerHTML = `<span class="opendigit">${open}</span><span class="closedigit">${close}</span>`;
      else td.innerHTML = SHOW_INDEX ? `<div class="cell-index">${idx}</div><div class="empty-faint">${idx}</div>` : '';
      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
}
renderTable();

/* controls */
document.getElementById('resizeBtn').onclick = function(){
  const newRows = Math.min(2000, Math.max(1, parseInt(document.getElementById('rowsInput').value,10) || 1));
  const newCols = Math.min(50, Math.max(1, parseInt(document.getElementById('colsInput').value,10) || 1));
  const newSize = newRows * newCols;
  const oldOpen = openDigits.slice();
  const oldClose = closeDigits.slice();
  ROWS = newRows; COLS = newCols;
  openDigits = Array(newSize).fill('');
  closeDigits = Array(newSize).fill('');
  for (let i=0;i<Math.min(oldOpen.length,newSize);i++) openDigits[i]=oldOpen[i];
  for (let i=0;i<Math.min(oldClose.length,newSize);i++) closeDigits[i]=oldClose[i];
  renderTable();
};

/* use improved parser for open/close */
document.getElementById('openBtn').onclick = function(){
  const raw = document.getElementById('openInput').value || '';
  const pairs = parseToPairs(raw);
  openDigits.fill('');
  pairs.forEach((token, idx) => {
    if (idx < openDigits.length && (token === '**' || token.toLowerCase() === 'xx' || /^\d{2}$/.test(token))) {
      openDigits[idx] = calculateCN(token);
    }
  });
  renderTable();
};
document.getElementById('closeBtn').onclick = function(){
  const raw = document.getElementById('closeInput').value || '';
  const pairs = parseToPairs(raw);
  closeDigits.fill('');
  pairs.forEach((token, idx) => {
    if (idx < closeDigits.length && (token === '**' || token.toLowerCase() === 'xx' || /^\d{2}$/.test(token))) {
      closeDigits[idx] = calculateCN(token);
    }
  });
  renderTable();
};

/* clears */
document.getElementById('clearOpenBtn').onclick = ()=>{ openDigits.fill(''); renderTable(); };
document.getElementById('clearCloseBtn').onclick = ()=>{ closeDigits.fill(''); renderTable(); };
document.getElementById('clearAllBtn').onclick = ()=>{ openDigits.fill(''); closeDigits.fill(''); renderTable(); };

/* toggle index */
document.getElementById('showIndexBtn').onclick = function(){
  SHOW_INDEX = !SHOW_INDEX;
  document.getElementById('showIndexState').textContent = SHOW_INDEX ? 'ON' : 'OFF';
  this.style.background = SHOW_INDEX ? '#16a34a' : '#3a5bea';
  renderTable();
};

/* edit cell via event delegation */
table.addEventListener('click', function(e){
  const td = e.target.closest('td');
  if (!td) return;
  const idx = parseInt(td.dataset.idx, 10);
  if (Number.isNaN(idx)) return;
  const prevOpen = openDigits[idx] || '';
  const prevClose = closeDigits[idx] || '';
  const inputOpen = prompt(`Cell ${idx}\nOpen value (2-digit or **/xx):`, prevOpen);
  if (inputOpen === null) return;
  const inputClose = prompt(`Cell ${idx}\nClose value (2-digit or **/xx):`, prevClose);
  if (inputClose === null) return;
  function setVal(input){ if(!input||input.trim()==='') return ''; input=input.trim(); return (input==='**'||input.toLowerCase()==='xx'||/^\d{2}$/.test(input))?calculateCN(input):''; }
  openDigits[idx]=setVal(inputOpen);
  closeDigits[idx]=setVal(inputClose);
  renderTable();
});

/* chart name live */
const chartNameTop = document.getElementById('chartNameTop');
const chartDisplay = document.getElementById('chartDisplay');
chartNameTop.addEventListener('input', ()=> chartDisplay.textContent = chartNameTop.value.trim() || 'My Chart');

/* save top */
function makeSavedHTML(chartName, ownerName) {
  let content = `<!doctype html><html><head><meta charset="utf-8"><title>${chartName}</title><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:sans-serif;background:#f4f9fe;padding:18px;} table{border-collapse:collapse;} td,th{border:1px solid #333;width:40px;height:40px;text-align:center;} .opendigit{color:#2186cc;font-weight:bold;} .closedigit{color:#eb2323;font-weight:bold;} @media(max-width:700px){td,th{width:24px;height:24px;font-size:12px;}}</style></head><body><h1>${chartName}</h1><table>`;
  for (let r=0;r<ROWS;r++){ content += '<tr>'; for (let c=0;c<COLS;c++){ let idx=r*COLS+c; let open = openDigits[idx] ? `<span class="opendigit">${openDigits[idx]}</span>` : ''; let close = closeDigits[idx] ? `<span class="closedigit">${closeDigits[idx]}</span>` : ''; content += `<td>${open}${close}</td>`; } content += '</tr>'; }
  content += '</table></body></html>';
  return content;
}
function downloadSavedFile(filename, chartName) {
  const content = makeSavedHTML(chartName || 'Saved Grid', '');
  const blob = new Blob([content], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  const fn = (filename && filename.trim()) ? filename.trim() : 'store.html';
  a.download = fn.endsWith('.html') ? fn : (fn + '.html');
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),3000);
}
document.getElementById('topSaveBtn').onclick = function(){
  const filename = document.getElementById('saveFilenameTop').value.trim() || 'store.html';
  const chartName = document.getElementById('chartNameTop').value.trim() || 'My Chart';
  downloadSavedFile(filename, chartName);
  this.textContent = 'Saved âœ“'; setTimeout(()=>{ this.textContent = 'Save (Top)'; }, 1400);
};
</script>
</body>
</html>
